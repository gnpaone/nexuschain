<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusChain Simulator - IoEV Trading</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen p-6">
    <div class="max-w-7xl mx-auto space-y-6">
        <header class="flex justify-between items-center pb-6 border-b border-gray-700">
            <div>
                <h1
                    class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
                    NexusChain Simulator
                </h1>
                <p class="text-gray-400 text-sm">Simulate Blockchain Consensus</p>
            </div>
            <div class="flex items-center space-x-4">
                <div id="status-indicator" class="flex items-center space-x-2">
                    <span class="w-3 h-3 rounded-full bg-red-500 animate-pulse" id="status-dot"></span>
                    <span class="text-sm font-medium" id="status-text">Stopped</span>
                </div>
            </div>
        </header>
        <div class="glass p-6 grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Number of Nodes</label>
                <input type="number" id="num_nodes" value="{{ config.num_nodes|default:10 }}"
                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Network Delay (sec)</label>
                <input type="number" id="delay" value="{{ config.min_delay|default:0.1 }}" step="0.1"
                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white">
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-400 mb-1">Network Mode</label>
                <select id="network_mode" onchange="toggleDelayInput(); saveModeLocal()"
                    class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white">
                    <option value="fixed">Fixed</option>
                    <option value="randomized">Randomized</option>
                    <option value="manual">Manual</option>
                </select>
            </div>
            <div class="flex space-x-2">
                <button id="startBtn" onclick="startSim()" disabled
                    class="flex-1 bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 text-white font-semibold py-2 px-4 rounded shadow-lg transition flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="startLoader" class="loader hidden"></span> Start
                </button>
                <button id="stopBtn" onclick="stopSim()" disabled
                    class="flex-1 bg-red-600 hover:bg-red-500 text-white font-semibold py-2 px-4 rounded shadow-lg transition flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="stopLoader" class="loader hidden"></span> Stop
                </button>
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass p-4 h-64">
                <h3 class="text-sm font-medium text-gray-400 mb-2">Throughput (Blocks/Min)</h3>
                <canvas id="throughputChart"></canvas>
            </div>
            <div class="glass p-4 h-64">
                <h3 class="text-sm font-medium text-gray-400 mb-2">Consensus Latency (s)</h3>
                <canvas id="latencyChart"></canvas>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Nodes List -->
            <div class="lg:col-span-2 space-y-4">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-white">Consensus Nodes</h2>
                    <span class="text-xs bg-gray-700 px-2 py-1 rounded text-gray-300" id="node-count">0 Nodes</span>
                </div>
                <div class="glass p-4 h-[500px] overflow-y-auto">
                    <div id="nodes-container" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
                </div>
            </div>
            <div class="space-y-6">
                <!-- Latest Blocks -->
                <div class="glass p-4 h-[240px] overflow-hidden flex flex-col">
                    <h2 class="text-sm font-semibold text-white mb-2">Latest Blocks</h2>
                    <div id="blocks-container" class="space-y-2 overflow-y-auto flex-1 text-xs"></div>
                </div>
                <div class="glass p-4 h-[240px] overflow-hidden flex flex-col">
                    <h2 class="text-sm font-semibold text-white mb-2">Network Events</h2>
                    <div id="events-container" class="space-y-2 overflow-y-auto flex-1 text-xs font-mono text-gray-400">
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <div id="editDelayModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="glass p-6 w-96 rounded-lg shadow-xl">
            <h3 class="text-lg font-bold text-white mb-4">Edit Node Delay</h3>
            <input type="hidden" id="editNodeId">
            <div class="mb-4">
                <label class="block text-xs font-medium text-gray-400 mb-1">New Delay (sec)</label>
                <input type="number" id="editNodeDelayVal" step="0.01"
                    class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closeEditModal()"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded text-sm text-white">Cancel</button>
                <button onclick="saveNodeDelay()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded text-sm text-white">Save</button>
            </div>
        </div>
    </div>

    <script>
        const ctxTp = document.getElementById('throughputChart').getContext('2d');
        const tpChart = new Chart(ctxTp, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Block Rate', data: [], borderColor: '#3b82f6', tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } }
        });

        const ctxLat = document.getElementById('latencyChart').getContext('2d');
        const latChart = new Chart(ctxLat, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Avg Latency', data: [], borderColor: '#10b981', tension: 0.4 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { x: { display: false }, y: { grid: { color: '#334155' } } } }
        });

        let isProcessing = false;
        let isStopping = false;

        async function updateDashboard() {
            try {
                const res = await fetch('/status/');
                const data = await res.json();

                const dot = document.getElementById('status-dot');
                const txt = document.getElementById('status-text');
                const startBtn = document.getElementById('startBtn');
                const stopBtn = document.getElementById('stopBtn');

                if (data.is_running) {
                    dot.classList.remove('bg-red-500'); dot.classList.add('bg-green-500');
                    txt.textContent = 'Running'; txt.classList.add('text-green-400');

                    startBtn.disabled = true;
                    document.getElementById('startLoader').classList.add('hidden');

                    document.getElementById('num_nodes').disabled = true;
                    document.getElementById('delay').disabled = true;
                    document.getElementById('network_mode').disabled = true;

                    if (data.num_nodes) document.getElementById('num_nodes').value = data.num_nodes;
                    if (data.delay) document.getElementById('delay').value = data.delay;
                    if (data.network_mode) {
                        document.getElementById('network_mode').value = data.network_mode;
                        toggleDelayInput();
                    }

                    if (!isStopping) {
                        stopBtn.disabled = false;
                        document.getElementById('stopLoader').classList.add('hidden');
                    } else {
                        stopBtn.disabled = true;
                        document.getElementById('stopLoader').classList.remove('hidden');
                    }
                } else {
                    dot.classList.add('bg-red-500'); dot.classList.remove('bg-green-500');
                    txt.textContent = 'Stopped'; txt.classList.remove('text-green-400');

                    startBtn.disabled = false;
                    document.getElementById('startLoader').classList.add('hidden');

                    document.getElementById('num_nodes').disabled = false;
                    document.getElementById('delay').disabled = false;
                    document.getElementById('network_mode').disabled = false;

                    stopBtn.disabled = true;
                    document.getElementById('stopLoader').classList.add('hidden');

                    isStopping = false;
                    isProcessing = false;

                    tpChart.data.labels = [];
                    tpChart.data.datasets[0].data = [];
                    tpChart.update();

                    latChart.data.labels = [];
                    latChart.data.datasets[0].data = [];
                    latChart.update();
                }

                document.getElementById('node-count').innerText = `${data.nodes.length} Nodes`;
                document.getElementById('nodes-container').innerHTML = data.nodes.map(n => {
                    let ringColor = 'border-blue-500';
                    if (n.reputation < 50) ringColor = 'border-red-500';
                    else if (n.reputation > 80) ringColor = 'border-green-400';

                    return `
                    <div onclick="window.location.href='/node/${n.id}/'" class="bg-gray-800 p-3 rounded border border-gray-700 hover:border-blue-500 cursor-pointer transition flex items-center space-x-3 relative group">
                        <div class="w-10 h-10 rounded-full bg-gray-900 border-2 ${ringColor} flex items-center justify-center font-bold text-xs text-blue-200">
                            ${n.name.split('-')[1] || n.name[0]}
                        </div>
                        <div class="flex-1">
                            <div class="text-xs font-bold text-gray-200">${n.name}</div>
                            <div class="text-[10px] text-gray-400">Rep: ${n.reputation.toFixed(1)} | Bal: ${n.balance}</div>
                            ${n.network_config && n.network_config.delay_range ?
                            `<div class="text-[10px] text-blue-300 mt-1">Delay: ${n.network_config.delay_range[0].toFixed(3)}-${n.network_config.delay_range[1].toFixed(3)}s</div>`
                            : ''}
                        </div>
                         <!-- Edit Button (only visible if allowed) -->
                        <button onclick="event.stopPropagation(); openEditModal('${n.id}')" 
                            class="absolute top-2 right-2 text-gray-500 hover:text-blue-400 opacity-0 group-hover:opacity-100 transition ${data.network_mode === 'manual' ? '' : 'hidden'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                        </button>
                    </div>`
                }).join('');

                document.getElementById('blocks-container').innerHTML = data.blocks.map(b => `
                    <div class="bg-gray-800/50 p-2 rounded border-l-2 border-purple-500 flex justify-between">
                        <div><span class="text-purple-300 font-bold">#${b.index}</span> <span class="text-gray-500">${b.hash.substring(0, 8)}...</span></div>
                        <div class="text-gray-400">${b.validator__name}</div>
                    </div>`).join('');

                document.getElementById('events-container').innerHTML = data.events.map(e => {
                    const msg = e.message;
                    let borderColor = 'border-gray-500';
                    let bgColor = 'bg-gray-800/30';
                    let textColor = 'text-gray-400';

                    if (msg.includes('Proposed block') || msg.includes('Quorum reached')) {
                        borderColor = 'border-transparent';
                        textColor = 'text-gray-400';
                    } else if (e.event_type.startsWith('PBFT_PREPARE')) {
                        borderColor = 'border-green-500';
                        textColor = 'text-green-300';
                    } else if (e.event_type.startsWith('PBFT_COMMIT')) {
                        borderColor = 'border-purple-500';
                        textColor = 'text-purple-300';
                    } else if (e.event_type === 'SYNC') {
                        borderColor = 'border-yellow-500';
                        textColor = 'text-yellow-300';
                    } else if (e.event_type === 'P2P_COMM') {
                        if (msg.includes('TRANSACTION')) {
                            borderColor = 'border-cyan-500';
                            textColor = 'text-cyan-300';
                        } else if (msg.includes('PREPARE')) {
                            borderColor = 'border-green-500';
                            textColor = 'text-green-300';
                        } else if (msg.includes('COMMIT')) {
                            borderColor = 'border-rose-500';
                            textColor = 'text-rose-300';
                        } else if (msg.includes('REPLY')) {
                            borderColor = 'border-indigo-500';
                            textColor = 'text-indigo-300';
                        }
                    } else if (e.event_type === 'BLOCK_PROPOSAL') {
                        borderColor = 'border-blue-500';
                        textColor = 'text-blue-300';
                    }

                    const isRecv = msg.includes('Received');
                    const isSent = msg.includes('Sent');
                    const borderClass = isSent ? 'border-r-2' : (isRecv ? 'border-l-2' : '');

                    return `
                    <div class="${bgColor} p-2 rounded ${borderClass} ${borderColor} mb-2 transition-all hover:bg-gray-800/50">
                        <div class="flex justify-between items-start mb-1">
                             <span class="text-[10px] text-blue-400/70 font-mono">[${new Date(e.timestamp).toLocaleTimeString()}]</span>
                             <span class="text-[10px] text-gray-500 font-bold">${e.node__name || 'Sys'}</span>
                        </div>
                        <div class="${textColor} text-[11px] leading-tight break-all">${msg}</div>
                    </div>`;
                }).join('');

                const mRes = await fetch('/metrics/');
                const metrics = await mRes.json();

                if (metrics.block_commits && metrics.block_commits.length > 0) {
                    tpChart.data.labels = metrics.block_commits.map(d => new Date(d.time * 1000).toLocaleTimeString());
                    tpChart.data.datasets[0].data = metrics.block_commits.map(d => d.value);
                    tpChart.update();
                }

                if (metrics.latency && metrics.latency.length > 0) {
                    latChart.data.labels = metrics.latency.map(d => new Date(d.time * 1000).toLocaleTimeString());
                    latChart.data.datasets[0].data = metrics.latency.map(d => d.value);
                    latChart.update();
                }
            } catch (e) {
                console.error("Dashboard update failed:", e);
            }
        }

        async function startSim() {
            if (isProcessing) return;
            isProcessing = true;
            const btn = document.getElementById('startBtn');
            const ldr = document.getElementById('startLoader');
            btn.disabled = true;
            ldr.classList.remove('hidden');

            document.getElementById('stopBtn').disabled = true;

            const formData = new FormData();
            formData.append('num_nodes', document.getElementById('num_nodes').value);
            formData.append('delay', document.getElementById('delay').value);
            formData.append('network_mode', document.getElementById('network_mode').value);

            try {
                await fetch('/start/', { method: 'POST', body: formData });
            } catch (e) {
                console.error("Start failed", e);
                btn.disabled = false;
                ldr.classList.add('hidden');
            } finally {
                isProcessing = false;
                setTimeout(updateDashboard, 500);
            }
        }

        async function stopSim() {
            if (isProcessing || isStopping) return;
            isProcessing = true;
            isStopping = true;

            const btn = document.getElementById('stopBtn');
            const ldr = document.getElementById('stopLoader');

            btn.disabled = true;
            ldr.classList.remove('hidden');

            document.getElementById('startBtn').disabled = true;

            try {
                const res = await fetch('/stop/', { method: 'POST' });
                if (!res.ok) {
                    throw new Error(`Server returned ${res.status}`);
                }
            } catch (e) {
                console.error("Stop failed", e);
                alert("Failed to stop simulation. Please try again.");
                isStopping = false;
            } finally {
                isProcessing = false;
                setTimeout(updateDashboard, 500);
            }
        }

        setInterval(updateDashboard, 2000);
        updateDashboard();

        function openEditModal(nodeId) {
            document.getElementById('editNodeId').value = nodeId;
            document.getElementById('editDelayModal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('editDelayModal').classList.add('hidden');
        }

        async function saveNodeDelay() {
            const nodeId = document.getElementById('editNodeId').value;
            const delay = document.getElementById('editNodeDelayVal').value;

            try {
                const formData = new FormData();
                formData.append('node_id', nodeId);
                formData.append('delay', delay);

                const res = await fetch('/update_node_delay/', { method: 'POST', body: formData });
                if (res.ok) {
                    alert("Node delay updated!");
                    closeEditModal();
                } else {
                    alert("Failed to update.");
                }
            } catch (e) {
                console.error(e);
                alert("Error updating delay.");
            }
        }

        function toggleDelayInput() {
            const mode = document.getElementById('network_mode').value;
            const delayInputDiv = document.getElementById('delay').parentElement;
            if (mode === 'fixed') {
                delayInputDiv.classList.remove('hidden');
                delayInputDiv.classList.add('block');
            } else {
                delayInputDiv.classList.add('hidden');
                delayInputDiv.classList.remove('block');
            }
        }

        function saveModeLocal() {
            const mode = document.getElementById('network_mode').value;
            localStorage.setItem('sim_network_mode', mode);
        }

        const savedMode = localStorage.getItem('sim_network_mode');
        if (savedMode) {
            document.getElementById('network_mode').value = savedMode;
        }
        toggleDelayInput();
    </script>
</body>

</html>